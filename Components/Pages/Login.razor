@page "/login"
@page "/"
@layout JUpdate.Components.Layout.LoginLayout
@inject JUpdate.Services.AuthService AuthService
@inject JUpdate.Services.DatabaseService DbService
@inject NavigationManager Navigation
@inject IJSRuntime JSRuntime

<div class="login-container">
    <div class="login-content">
        <!-- Header Section -->
        <div class="login-header">
            <div class="app-icon">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect width="48" height="48" rx="8" fill="#7C917C"/>
                    <path d="M14 16h20v2H14v-2zm0 4h20v2H14v-2zm0 4h14v2H14v-2z" fill="white"/>
                </svg>
            </div>
            <h1 class="app-title">Journal</h1>
            <p class="app-tagline">Your private thoughts, secured</p>
        </div>

        <!-- PIN Input Section -->
        <div class="pin-section" @onclick="FocusPinInput">
            <label class="pin-label">Enter your PIN</label>
            
            <!-- PIN Visual Dots -->
            <div class="pin-dots" @onclick="FocusPinInput">
                @for (int i = 0; i < 6; i++)
                {
                    <div class="pin-dot @(i < pinInput.Length ? "filled" : "")"></div>
                }
            </div>

            <!-- PIN Input (visually hidden but functional) -->
            <input type="tel" 
                   inputmode="numeric"
                   pattern="[0-9]*"
                   class="pin-input-hidden" 
                   value="@pinInput"
                   @oninput="HandleInput"
                   maxlength="6"
                   @onkeypress="HandleKeyPress"
                   @ref="pinInputRef"
                   tabindex="0"/>
        </div>

        <!-- Error Message -->
        @if (!string.IsNullOrEmpty(errorMessage))
        {
            <div class="error-message">@errorMessage</div>
        }

        <!-- Action Button -->
        <button class="unlock-button" @onclick="HandleUnlock" disabled="@(pinInput.Length != 6)">
            <svg width="20" height="20" viewBox="0 0 20 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M5 9V6a5 5 0 0 1 10 0v3M10 13v2M5 9h10a2 2 0 0 1 2 2v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-6a2 2 0 0 1 2-2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
            Unlock Journal
        </button>

        <!-- Forgot PIN Link -->
        <a href="#" class="forgot-pin-link" @onclick="HandleForgotPin" @onclick:preventDefault>Forgot PIN?</a>

        <!-- Footer -->
        <div class="login-footer">
            <svg width="16" height="16" viewBox="0 0 16 16" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M8 1L2 4v3c0 3.31 2.69 6 6 6s6-2.69 6-6V4l-6-3zM8 9.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" fill="#A0AEC0"/>
            </svg>
            <span>Your data is encrypted and secure</span>
        </div>
    </div>
</div>

@code {
    private string pinInput = string.Empty;
    private string? errorMessage = string.Empty;
    private ElementReference pinInputRef;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Check if PIN is set, if not, redirect to PIN setup
            try 
            {
                if (!AuthService.HasPin())
                {
                    Navigation.NavigateTo("/pin-setup");
                    return;
                }
            }
            catch (Exception ex)
            {
                errorMessage = $"Auth Check Error: {ex.Message}";
                StateHasChanged();
            }
            
            // Focus the PIN input after render
            try
            {
                await pinInputRef.FocusAsync();
            }
            catch { }
        }
    }

    private async Task FocusPinInput()
    {
        try
        {
            await Task.Delay(10); // Small delay to ensure DOM is ready
            await pinInputRef.FocusAsync();
            await Task.Delay(10);
            StateHasChanged(); // Force UI update
        }
        catch (Exception ex)
        {
            // Try alternative method if FocusAsync fails
            Console.WriteLine($"Focus error: {ex.Message}");
        }
    }

    private void HandleInput(ChangeEventArgs e)
    {
        // Filter to only allow digits
        var input = e.Value?.ToString() ?? string.Empty;
        var filtered = new string(input.Where(char.IsDigit).Take(6).ToArray());
        pinInput = filtered;
        StateHasChanged();
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && pinInput.Length == 6)
        {
            await HandleUnlock();
        }
    }

    private async Task HandleUnlock()
    {
        if (pinInput.Length != 6)
            return;

        errorMessage = string.Empty;
        StateHasChanged();
        
        // Simulating async work if needed
        await Task.Yield(); 

        try
        {
            // Verify the PIN
            if (AuthService.VerifyPin(pinInput))
            {
                AuthService.SetAuthenticated(true);
                Navigation.NavigateTo("/dashboard");
            }
            else
            {
                errorMessage = "Incorrect PIN. Please try again.";
                pinInput = string.Empty;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Login Error: {ex.GetType().Name} - {ex.Message}";
            Console.WriteLine(ex);
            StateHasChanged();
        }
    }

    private async Task HandleForgotPin()
    {
        try
        {
            bool confirmed = await JSRuntime.InvokeAsync<bool>("confirm", "Forgetting your PIN will reset the app security. Your journal entries will remain safe, but you will need to create a new PIN. Continue?");
            if (confirmed)
            {
                DbService.ClearUserPin();
                Navigation.NavigateTo("/pin-setup", forceLoad: true);
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"An error occurred: {ex.Message}";
        }
    }
}


<style>
    :root {
        --bg-grid: #1a1a1a;
        --bg-paper: #2b2b2b;
        --text-chalk: #f0f0f0;
        --tape-color: #d4c5a3;
        --accent-purple: #a78bfa;
    }

    .login-container {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        background-color: #111;
        background-image: 
            linear-gradient(rgba(255, 255, 255, 0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255, 255, 255, 0.03) 1px, transparent 1px);
        background-size: 20px 20px;
    }

    .login-content {
        background: var(--bg-paper);
        border-radius: 16px;
        padding: 40px;
        width: 100%;
        max-width: 400px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        text-align: center;
        position: relative;
    }

    /* Tape styles */
    .login-content::before {
        content: '';
        position: absolute;
        width: 120px;
        height: 35px;
        background-color: var(--tape-color);
        top: -15px;
        left: 50%;
        transform: translateX(-50%) rotate(-2deg);
        opacity: 0.8;
        box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        z-index: 10;
        clip-path: polygon(2% 0%, 98% 2%, 100% 98%, 0% 100%);
    }

    .login-header {
        margin-bottom: 24px;
    }

    .app-icon {
        margin-bottom: 16px;
    }

    .app-title {
        font-family: 'Segoe UI', cursive;
        font-size: 2rem;
        color: white;
        margin: 0 0 8px 0;
        text-shadow: 0 0 10px rgba(255,255,255,0.1);
    }

    .app-tagline {
        color: #888;
        font-style: italic;
        margin: 0;
    }

    .pin-label {
        display: block;
        margin-bottom: 16px;
        color: #ccc;
        font-weight: 500;
    }

    .pin-dots {
        display: flex;
        justify-content: center;
        gap: 12px;
        margin-bottom: 24px;
        cursor: text;
    }

    .pin-dot {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        background-color: #444;
        transition: all 0.2s ease;
        border: 1px solid #555;
    }

    .pin-dot.filled {
        background-color: var(--accent-purple);
        transform: scale(1.1);
        box-shadow: 0 0 10px rgba(167, 139, 250, 0.5);
        border-color: #c4b5fd;
    }

    .pin-input-hidden {
        position: absolute;
        opacity: 0;
        top: 0;
        left: 0;
        height: 0;
        width: 0;
    }

    .unlock-button {
        width: 100%;
        padding: 12px;
        border-radius: 8px;
        background: var(--accent-purple);
        color: #1a1a1a;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        font-size: 1rem;
        margin-bottom: 16px;
    }

    .unlock-button:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(167, 139, 250, 0.3);
    }

    .unlock-button:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
    }

    .forgot-pin-link {
        display: block;
        color: #888;
        text-decoration: none;
        font-size: 0.9rem;
        margin-bottom: 32px;
        transition: color 0.2s;
    }

    .forgot-pin-link:hover {
        color: white;
        text-decoration: underline;
    }

    .login-footer {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        color: #666;
        font-size: 0.8rem;
    }

    .error-message {
        background: rgba(239, 68, 68, 0.1);
        color: #ef4444;
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(239, 68, 68, 0.2);
        margin-bottom: 20px;
        font-size: 0.9rem;
    }
</style>
