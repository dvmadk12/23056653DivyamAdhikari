@page "/mood-tracker"
@using JUpdate.Models
@using JUpdate.Services
@inject JournalService JournalService

<div class="mood-tracker-page">
    <div class="page-header">
        <h1>Mood Tracker</h1>
        <p>Analyze your emotional journey</p>
    </div>

    @if (allEntries == null || !allEntries.Any())
    {
        <div class="empty-state">
            <p>Not enough data to analyze moods yet. Write some entries!</p>
        </div>
    }
    else
    {
        <div class="stats-grid">
            <!-- Total Entries Card -->
            <div class="stat-card">
                <div class="stat-value">@allEntries.Count</div>
                <div class="stat-label">Total Entries</div>
            </div>

            <!-- Most Frequent Mood -->
            <div class="stat-card">
                <div class="stat-value">@topMood?.Name @topMood?.Emoji</div>
                <div class="stat-label">Top Mood</div>
            </div>
            
             <!-- Streak (SImple) -->
            <div class="stat-card">
                <div class="stat-value">@currentStreak</div>
                <div class="stat-label">Day Streak</div>
            </div>
        </div>

        <div class="mood-breakdown">
            <h2 class="section-title">Mood Breakdown</h2>
            <div class="mood-list">
                @foreach (var item in moodCounts.OrderByDescending(x => x.Value))
                {
                    var mood = moods.FirstOrDefault(m => m.Id == item.Key);
                    var percentage = (double)item.Value / allEntries.Count * 100;
                    
                    if (mood != null)
                    {
                        <div class="mood-bar-item">
                            <div class="mood-info">
                                <span class="mood-emoji">@mood.Emoji</span>
                                <span class="mood-name">@mood.Name</span>
                                <span class="mood-count">@item.Value</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" style="width: @percentage%"></div>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    }
</div>

@code {
    private List<JournalEntry> allEntries = new();
    private List<Mood> moods = new();
    private Dictionary<int, int> moodCounts = new();
    private Mood? topMood;
    private int currentStreak;

    protected override void OnInitialized()
    {
        LoadData();
    }

    private void LoadData()
    {
        allEntries = JournalService.GetAllEntries();
        moods = JournalService.GetMoods();

        if (allEntries != null && allEntries.Any())
        {
            // Count moods
            moodCounts = allEntries
                .GroupBy(e => e.PrimaryMoodId)
                .ToDictionary(g => g.Key, g => g.Count());

            // Find top mood
            var topMoodId = moodCounts.OrderByDescending(x => x.Value).FirstOrDefault().Key;
            topMood = moods.FirstOrDefault(m => m.Id == topMoodId);

            // Calculate streak (consecutive days)
            CalculateStreak();
        }
    }

    private void CalculateStreak()
    {
        currentStreak = 0;
        if (!allEntries.Any()) return;

        var dates = allEntries.Select(e => e.EntryDate.Date).Distinct().OrderByDescending(d => d).ToList();
        var today = DateTime.Today;
        
        // Check if there is an entry for today or yesterday to start the streak
        if (dates.Contains(today))
        {
            currentStreak = 1;
        }
        else if (dates.Contains(today.AddDays(-1)))
        {
             // Streak is alive but no entry today yet
        }
        else
        {
            return; // Streak broken
        }

        // Count backwards
        var checkDate = dates.Contains(today) ? today.AddDays(-1) : today.AddDays(-1);
        
        while (dates.Contains(checkDate))
        {
            currentStreak++;
            checkDate = checkDate.AddDays(-1);
        }
    }
}

<style>
    .mood-tracker-page {
        padding: 24px;
        max-width: 800px;
        margin: 0 auto;
    }

    .page-header {
        margin-bottom: 32px;
    }

    .page-header h1 {
        font-size: 2rem;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 8px;
    }

    .page-header p {
        color: var(--text-secondary);
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 16px;
        margin-bottom: 40px;
    }

    .stat-card {
        background: var(--bg-surface);
        border: 1px solid var(--border-color);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: 0 2px 4px rgba(0,0,0,0.02);
    }

    .stat-value {
        font-size: 2rem;
        font-weight: 800;
        color: var(--primary-color);
        margin-bottom: 4px;
    }

    .stat-label {
        color: var(--text-secondary);
        font-size: 0.9rem;
        font-weight: 500;
    }

    .section-title {
        font-size: 1.25rem;
        font-weight: 600;
        color: var(--text-primary);
        margin-bottom: 20px;
    }

    .mood-list {
        display: flex;
        flex-direction: column;
        gap: 16px;
    }

    .mood-bar-item {
        background: var(--bg-surface);
        padding: 16px;
        border-radius: 8px;
        border: 1px solid var(--border-color);
    }

    .mood-info {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }

    .mood-emoji {
        font-size: 1.5rem;
        margin-right: 12px;
    }

    .mood-name {
        font-weight: 600;
        color: var(--text-primary);
        flex: 1;
    }

    .mood-count {
        color: var(--text-secondary);
        font-weight: 500;
    }

    .progress-bar-container {
        height: 8px;
        background: var(--bg-hover);
        border-radius: 4px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: var(--primary-color);
        border-radius: 4px;
        transition: width 0.5s ease-out;
    }
</style>
